---
- hosts: MySQL
  tasks:
    - name: Update package cache
      become: true
      package:
        name: '*'
        state: latest
        update_cache: yes

    - name: Install Git
      become: true
      package:
        name: git
        state: present
    - name: Clone repository for mysql
      git:
        repo: https://github.com/khanadm/work-space.git
        dest: /home/ec2-user/ongraph/
        clone: true
    - name: Build Docker image
      command: docker build -t mysql /home/ec2-user/ongraph/php_application/backend
    - name: Running  Docker container from  image
      command: docker run --name mysql -p 3306:3306 -d mysql




- hosts: php_application
  tasks:
    - name: Update package cache
      become: true
      package:
        name: '*'
        state: latest
        update_cache: yes

    - name: Install Git
      become: true
      package:
        name: git
        state: present
    - name: Clone repository for mysql
      git:
        repo: https://github.com/khanadm/work-space.git
        dest: /home/ec2-user/ongraph
        clone: true
    - name: Fill db_server_ip  in Dockerfile
      lineinfile:
        path: /home/ec2-user/ongraph/php_application/frontend/Dockerfile
        regexp: '^ENV DB_SERVER='
        line: 'ENV DB_SERVER={{ hostvars[groups.MySQL.0].public_ip_address if groups.MySQL|length > 0 else "" }}'
    - name: Build Docker image
      command: docker build -t myapp /home/ec2-user/ongraph/php_application/frontend
    - name: Build Docker container
      command: docker run --name php_application -p 80:80 -d myapp
